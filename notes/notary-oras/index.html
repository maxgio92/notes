<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Sign images with Notation - maxgio's notes</title><meta name=description content="Sign image with Notary and ORAS Notary and Notation Notary project is a set of tools that helps you sign, store, and verify OCI artifacts using OCI-conformant registries.
Notation is an implementation of the Notary v2 specifications. As an implementation provides a CLI that adds signatures as standard items in the registry ecosystem, and can build a set of simple tooling for signing and verifying these signatures.
Notary v2 provides for multiple signatures of an OCI Artifact (including container images) to be persisted in an OCI conformant registry."><meta name=author content><link rel="preload stylesheet" as=style href=https://notes.maxgio.me/app.min.css><link rel="preload stylesheet" as=style href=https://notes.maxgio.me/an-old-hope.min.css><script defer src=https://notes.maxgio.me/highlight.min.js onload=hljs.initHighlightingOnLoad();></script><link rel=preload as=image href=https://notes.maxgio.me/theme.png><link rel=icon href=https://notes.maxgio.me/favicon.ico><link rel=apple-touch-icon href=https://notes.maxgio.me/apple-touch-icon.png><meta name=generator content="Hugo 0.79.1"><meta property="og:title" content="Sign images with Notation"><meta property="og:description" content="Sign image with Notary and ORAS Notary and Notation Notary project is a set of tools that helps you sign, store, and verify OCI artifacts using OCI-conformant registries.
Notation is an implementation of the Notary v2 specifications. As an implementation provides a CLI that adds signatures as standard items in the registry ecosystem, and can build a set of simple tooling for signing and verifying these signatures.
Notary v2 provides for multiple signatures of an OCI Artifact (including container images) to be persisted in an OCI conformant registry."><meta property="og:type" content="article"><meta property="og:url" content="https://notes.maxgio.me/notes/notary-oras/"><meta itemprop=name content="Sign images with Notation"><meta itemprop=description content="Sign image with Notary and ORAS Notary and Notation Notary project is a set of tools that helps you sign, store, and verify OCI artifacts using OCI-conformant registries.
Notation is an implementation of the Notary v2 specifications. As an implementation provides a CLI that adds signatures as standard items in the registry ecosystem, and can build a set of simple tooling for signing and verifying these signatures.
Notary v2 provides for multiple signatures of an OCI Artifact (including container images) to be persisted in an OCI conformant registry."><meta itemprop=wordCount content="531"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Sign images with Notation"><meta name=twitter:description content="Sign image with Notary and ORAS Notary and Notation Notary project is a set of tools that helps you sign, store, and verify OCI artifacts using OCI-conformant registries.
Notation is an implementation of the Notary v2 specifications. As an implementation provides a CLI that adds signatures as standard items in the registry ecosystem, and can build a set of simple tooling for signing and verifying these signatures.
Notary v2 provides for multiple signatures of an OCI Artifact (including container images) to be persisted in an OCI conformant registry."></head><body class=not-ready data-menu=false><header class=header><p class=logo><a class=site-name href=https://notes.maxgio.me/>maxgio's notes</a><a class=btn-dark></a></p><script>let bodyClx=document.body.classList;let btnDark=document.querySelector('.btn-dark');let sysDark=window.matchMedia('(prefers-color-scheme: dark)');let darkVal=localStorage.getItem('dark');let setDark=(isDark)=>{bodyClx[isDark?'add':'remove']('dark');localStorage.setItem('dark',isDark?'yes':'no');};setDark(darkVal?darkVal==='yes':sysDark.matches);requestAnimationFrame(()=>bodyClx.remove('not-ready'));btnDark.addEventListener('click',()=>setDark(!bodyClx.contains('dark')));sysDark.addEventListener('change',(event)=>setDark(event.matches));</script></header><main class=main><article class=post-single><header class=post-title><p></p><h1>Sign images with Notation</h1></header><section class=post-content><h1 id=sign-image-with-notary-and-oras>Sign image with Notary and ORAS</h1><h2 id=notary-and-notation>Notary and Notation</h2><p><a href=https://notaryproject.dev/>Notary project</a> is a set of tools that helps you sign, store, and verify OCI artifacts using OCI-conformant registries.</p><p><a href>Notation</a> is an implementation of the <a href=https://github.com/notaryproject/notaryproject>Notary v2 specifications</a>.
As an implementation provides a CLI that adds signatures as standard items in the registry ecosystem, and can build a set of simple tooling for signing and verifying these signatures.</p><p>Notary v2 provides for multiple signatures of an <a href=https://github.com/opencontainers/artifacts>OCI Artifact</a> (including container images) to be persisted in an OCI conformant registry.
Artifacts are signed with private keys, and validated with public keys.</p><p>To support user deployment flows, signing an OCI Artifact will not change the @digest or artifact:tag reference.
To support content movement across multiple certification boundaries, artifacts and their signatures will be easily copied within and across OCI conformant registries.</p><p>To deliver on the Notary v2 goals of cross registry movement of artifacts with their signatures, changes to several projects are anticipated, including <a href=https://github.com/opencontainers/distribution-spec>OCI distribution-spec</a>, <a href=https://github.com/distribution/distribution>CNCF Distribution</a>, <a href=https://github.com/opencontainers/artifacts>OCI Artifacts</a>, <a href=https://github.com/oras-project/oras>ORAS</a> with further consumption from projects (e.g. <a href=https://github.com/containerd/containerd>containerd</a>).</p><p>Already changes are coming in ORAS that unified the ORAS artifact spec into the new OCI artifact spec, to cover scenarios where images aren&rsquo;t the only artifact to be distributed, such as signatures, SBOMs, attestation, etc. but that references container-related artifacts.</p><h2 id=oci-and-oras>OCI and ORAS</h2><p>Notation leverages ORAS to store signatures into OCI registry [&mldr;].</p><p><a href>ORAS</a> project is [&mldr;].</p><h2 id=quickstart>Quickstart</h2><h3 id=requirements>Requirements</h3><ul><li><a href=https://docs.docker.com/engine/reference/commandline/cli/>docker</a> or <a href=https://docs.podman.io/en/latest/Commands.html>podman</a></li><li><a href=https://github.com/notaryproject/notation/releases>notation</a></li><li><a href=https://github.com/containers/skopeo/blob/main/install.md>skopeo</a></li></ul><h3 id=run-the-demo>Run the demo</h3><p>Run a local <a href=https://github.com/oras-project>ORAS</a> OCI regsitry:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>export PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>5000</span>
export REGISTRY<span style=color:#f92672>=</span>localhost:<span style=color:#e6db74>${</span>PORT<span style=color:#e6db74>}</span>

docker run -d -p <span style=color:#e6db74>${</span>PORT<span style=color:#e6db74>}</span>:5000 ghcr.io/oras-project/registry:v0.0.3-alpha
</code></pre></div><p>Build and push an OCI image to the local registry with a tag:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>export REPO<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>REGISTRY<span style=color:#e6db74>}</span>/net-monitor
export IMAGE<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>REPO<span style=color:#e6db74>}</span>:v1

docker build -t $IMAGE https://github.com/wabbit-networks/net-monitor.git#main
docker push $IMAGE
</code></pre></div><p>See how the image is not signed (the are no signing artifacts on the local repository that reference the just pushed image):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>notation list --plain-http $IMAGE
</code></pre></div><p>Generate a certificate key pair to sign the image:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>notation cert generate-test --default <span style=color:#e6db74>&#34;wabbit-networks.io&#34;</span>
</code></pre></div><p>Sign the image with the certificate key just created:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>notation sign --plain-http $IMAGE
</code></pre></div><p>Add the certificate to the local trust store:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>notation cert add --name <span style=color:#e6db74>&#34;wabbit-networks.io&#34;</span> ~/.config/notation/localkeys/wabbit-networks.io.crt
</code></pre></div><p>Verify that the image is signed, against the trust store.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>notation verify --plain-http $IMAGE
</code></pre></div><p>But now, let&rsquo;s get more detail and see what is a signature.</p><h2 id=inpspect-the-signature-artifacts>Inpspect the signature artifacts</h2><p>As of now of Notation v0.12 a signature is an ORAS <a href=https://github.com/oras-project/artifacts-spec>artifact-spec</a> compatible OCI image, on an OCI registry that references an OCI image.
As a digest makes unique an artifact (i.e. an image), the <code>subject</code> field of the signature image manifest references the signing content.</p><p>Let&rsquo;s check that on our local registry!</p><h3 id=inspect-with-skopeo>Inspect with Skopeo</h3><p>Skopeo is a command line utility that performs various operations on container images and image repositories.
It is able to inspect a repository on a container registry and fetch images manifests and layers.</p><p>So, let&rsquo;s analyse the local registry with Skopeo, and see how the signed image is referenced by the signature in his image manifest.</p><p>Get the signature digest:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>notation list --plain-http $IMAGE
</code></pre></div><p>Inspect the <code>subject</code>&rsquo;s digest of the signature image manifest:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>skopeo inspect --tls-verify<span style=color:#f92672>=</span>false docker://localhost:5000/net-monitor@sha256:$SIG_DIGEST --raw | jq <span style=color:#e6db74>&#39;.subject.digest&#39;</span>
</code></pre></div><p>We see that it matches the digest of the signed image.</p><p>The end!</p></section><nav class=post-nav><a class=prev href=https://notes.maxgio.me/notes/rsa/><span>←</span><span>RSA</span></a>
<a class=next href=https://notes.maxgio.me/notes/tweets/><span>Tweets</span><span>→</span></a></nav></article></main><footer class=footer><p>&copy; 2022 <a href=https://notes.maxgio.me/>maxgio's notes</a></p><p>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>️</p><p><a href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>Paper 5.1</a></p></footer></body></html>