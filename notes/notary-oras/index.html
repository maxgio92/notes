<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Notary, ORAS and OCI - maxgio's notes</title><meta name=description content="Sign image with Notary and ORAS Notary and Notation Notary project is a set of tools that helps you sign, store, and verify OCI artifacts using OCI-conformant registries.
Notation is an implementation of the Notary v2 specifications. As an implementation provides a CLI that adds signatures as standard items in the registry ecosystem, and can build a set of simple tooling for signing and verifying these signatures.
Notary v2 provides for multiple signatures of an OCI Artifact (including container images) to be persisted in an OCI conformant registry."><meta name=author content><link rel="preload stylesheet" as=style href=https://notes.maxgio.me/app.min.css><link rel="preload stylesheet" as=style href=https://notes.maxgio.me/an-old-hope.min.css><script defer src=https://notes.maxgio.me/highlight.min.js onload=hljs.initHighlightingOnLoad();></script><link rel=preload as=image href=https://notes.maxgio.me/theme.png><link rel=icon href=https://notes.maxgio.me/favicon.ico><link rel=apple-touch-icon href=https://notes.maxgio.me/apple-touch-icon.png><meta name=generator content="Hugo 0.79.1"><meta property="og:title" content="Notary, ORAS and OCI"><meta property="og:description" content="Sign image with Notary and ORAS Notary and Notation Notary project is a set of tools that helps you sign, store, and verify OCI artifacts using OCI-conformant registries.
Notation is an implementation of the Notary v2 specifications. As an implementation provides a CLI that adds signatures as standard items in the registry ecosystem, and can build a set of simple tooling for signing and verifying these signatures.
Notary v2 provides for multiple signatures of an OCI Artifact (including container images) to be persisted in an OCI conformant registry."><meta property="og:type" content="article"><meta property="og:url" content="https://notes.maxgio.me/notes/notary-oras/"><meta itemprop=name content="Notary, ORAS and OCI"><meta itemprop=description content="Sign image with Notary and ORAS Notary and Notation Notary project is a set of tools that helps you sign, store, and verify OCI artifacts using OCI-conformant registries.
Notation is an implementation of the Notary v2 specifications. As an implementation provides a CLI that adds signatures as standard items in the registry ecosystem, and can build a set of simple tooling for signing and verifying these signatures.
Notary v2 provides for multiple signatures of an OCI Artifact (including container images) to be persisted in an OCI conformant registry."><meta itemprop=wordCount content="1663"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Notary, ORAS and OCI"><meta name=twitter:description content="Sign image with Notary and ORAS Notary and Notation Notary project is a set of tools that helps you sign, store, and verify OCI artifacts using OCI-conformant registries.
Notation is an implementation of the Notary v2 specifications. As an implementation provides a CLI that adds signatures as standard items in the registry ecosystem, and can build a set of simple tooling for signing and verifying these signatures.
Notary v2 provides for multiple signatures of an OCI Artifact (including container images) to be persisted in an OCI conformant registry."></head><body class=not-ready data-menu=false><header class=header><p class=logo><a class=site-name href=https://notes.maxgio.me/>maxgio's notes</a><a class=btn-dark></a></p><script>let bodyClx=document.body.classList;let btnDark=document.querySelector('.btn-dark');let sysDark=window.matchMedia('(prefers-color-scheme: dark)');let darkVal=localStorage.getItem('dark');let setDark=(isDark)=>{bodyClx[isDark?'add':'remove']('dark');localStorage.setItem('dark',isDark?'yes':'no');};setDark(darkVal?darkVal==='yes':sysDark.matches);requestAnimationFrame(()=>bodyClx.remove('not-ready'));btnDark.addEventListener('click',()=>setDark(!bodyClx.contains('dark')));sysDark.addEventListener('change',(event)=>setDark(event.matches));</script></header><main class=main><article class=post-single><header class=post-title><p></p><h1>Notary, ORAS and OCI</h1></header><section class=post-content><h1 id=sign-image-with-notary-and-oras>Sign image with Notary and ORAS</h1><h2 id=notary-and-notation>Notary and Notation</h2><p><a href=https://notaryproject.dev/>Notary project</a> is a set of tools that helps you sign, store, and verify OCI artifacts using OCI-conformant registries.</p><p><a href>Notation</a> is an implementation of the <a href=https://github.com/notaryproject/notaryproject>Notary v2 specifications</a>.
As an implementation provides a CLI that adds signatures as standard items in the registry ecosystem, and can build a set of simple tooling for signing and verifying these signatures.</p><p>Notary v2 provides for multiple signatures of an <a href=https://github.com/opencontainers/artifacts>OCI Artifact</a> (including container images) to be persisted in an OCI conformant registry.
Artifacts are signed with private keys, and validated with public keys.</p><p>To support user deployment flows, signing an OCI Artifact will not change the @digest or artifact:tag reference.
To support content movement across multiple certification boundaries, artifacts and their signatures will be easily copied within and across OCI conformant registries.</p><p>To deliver on the Notary v2 goals of cross registry movement of artifacts with their signatures, changes to several projects are anticipated, including <a href=https://github.com/opencontainers/distribution-spec>OCI distribution-spec</a>, <a href=https://github.com/distribution/distribution>CNCF Distribution</a>, <a href=https://github.com/opencontainers/artifacts>OCI Artifacts</a>, <a href=https://github.com/oras-project/oras>ORAS</a> with further consumption from projects (e.g. <a href=https://github.com/containerd/containerd>containerd</a>).</p><p>Already changes are coming in ORAS that unified the ORAS artifact spec into the new OCI artifact spec, to cover scenarios where images aren&rsquo;t the only artifact to be distributed, such as signatures, SBOMs, attestation, etc. but that references container-related artifacts.</p><h2 id=oci-and-oras>OCI and ORAS</h2><p>Notation leverages ORAS to store signatures into OCI registries.
The <a href=https://oras.land/>ORAS project</a> is a set of tools and libraries that enable to use OCI registries to store arbitray artifacts.
But what are OCI Registries?</p><p>The <a href=https://opencontainers.org/>Open Container Initiative</a> (OCI) defines the specifications and standards for container technologies.
This includes the <a href=https://github.com/opencontainers/distribution-spec>OCI Distribution Specification</a>, the API for working with container registries.
Registries that implement the distribution-spec are referred to as OCI Registries.</p><h3 id=oci-and-oras-artifacts>OCI and ORAS artifacts</h3><p>The main OCI artifact type is the <a href=https://github.com/opencontainers/image-spec>OCI image</a>. With time, people used registries to store arbitrary artifacts, leveraging performance, security and reliability capabilities of registries.
One growing example is artifacts for securing the sofware supply chain like SBOMS, signatures, attestations, scan results, etc.</p><p>The <a href=https://github.com/opencontainers/artifacts>OCI artifacts</a> project aims to generalize the artifact types that can be distributed by and stored into OCI registries.
The image manifest has a <code>config.mediaType</code> field to differentiate between the various types of artifacts.
This field is supposed to be filled by the authors of new artifact types, so ORAS did to support a wide range of artifact types.</p><p>It introduced the <a href=https://github.com/oras-project/artifacts-spec>ORAS artifact specification</a> and related <code>application/vnd.cncf.oras.artifact.manifest.v1+json</code> <code>mediaType</code>.
This media type bases on the OCI image manifest but removes constraints such as a required <code>config</code> object and required & ordinal <code>layers</code> (more on the OCI image manifest spec <a href=https://github.com/opencontainers/image-spec/blob/main/manifest.md>here</a>).</p><p>The ORAS artifact manifest adds a <code>subject</code> property supporting a graph of independently linked artifacts.
It provides a means to define artifacts that can be related to an OCI image manifest, OCI image index or another ORAS artifact manifest (for example <a href=https://github.com/oras-project/artifacts-spec/blob/main/scenarios.md#notary-v2-signatures>here</a> a Notary V2 signature that references an image).
By defining a new manifest, registries and clients opt-into new capabilities, without breaking existing behaviour, such as discovery provided by the ORAS <a href=https://github.com/oras-project/artifacts-spec/blob/main/manifest-referrers-api.md#manifest-referrers-api>referrers API</a>.</p><h2 id=quickstart>Quickstart</h2><h3 id=requirements>Requirements</h3><ul><li><a href=https://docs.docker.com/engine/reference/commandline/cli/>Docker</a> or <a href=https://docs.podman.io/en/latest/Commands.html>Podman</a></li><li><a href=https://github.com/notaryproject/notation/releases>Notation</a></li><li><a href=https://oras.land/cli/>ORAS CLI</a></li></ul><h3 id=run-the-demo>Run the demo</h3><p>Run a local <a href=https://github.com/oras-project>ORAS</a> OCI regsitry:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>export PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>5000</span>
export REGISTRY<span style=color:#f92672>=</span>localhost:<span style=color:#e6db74>${</span>PORT<span style=color:#e6db74>}</span>

docker run -d -p <span style=color:#e6db74>${</span>PORT<span style=color:#e6db74>}</span>:5000 ghcr.io/oras-project/registry:v0.0.3-alpha
</code></pre></div><p>Build and push an OCI image to the local registry with a tag:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>export REPO<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>REGISTRY<span style=color:#e6db74>}</span>/net-monitor
export IMAGE<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>REPO<span style=color:#e6db74>}</span>:v1

docker build -t $IMAGE https://github.com/wabbit-networks/net-monitor.git#main
docker push $IMAGE
</code></pre></div><p>See how the image is not signed (the are no signing artifacts on the local repository that reference the just pushed image):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>notation list --plain-http $IMAGE
</code></pre></div><p>Generate a certificate key pair to sign the image:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>notation cert generate-test --default <span style=color:#e6db74>&#34;wabbit-networks.io&#34;</span>
</code></pre></div><p>Sign the image with the certificate key just created:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>notation sign --plain-http $IMAGE
</code></pre></div><p>Now you need to configure the <a href=https://notaryproject.dev/docs/concepts/trust-store-trust-policy-specification/#trust-policy>trust policy</a> to specify trusted identities which sign the artifacts, and level of signature verification to use:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cat &lt;&lt;<span style=color:#e6db74>&#34;EOF&#34;</span> &gt; ~/.config/notation/trustpolicy.json
<span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
    <span style=color:#e6db74>&#34;trustPolicies&#34;</span>: <span style=color:#f92672>[</span>
        <span style=color:#f92672>{</span>
            <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;wabbit-networks-images&#34;</span>,
            <span style=color:#e6db74>&#34;registryScopes&#34;</span>: <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;*&#34;</span> <span style=color:#f92672>]</span>,
            <span style=color:#e6db74>&#34;signatureVerification&#34;</span>: <span style=color:#f92672>{</span>
                <span style=color:#e6db74>&#34;level&#34;</span> : <span style=color:#e6db74>&#34;strict&#34;</span> 
            <span style=color:#f92672>}</span>,
            <span style=color:#e6db74>&#34;trustStores&#34;</span>: <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;ca:wabbit-networks.io&#34;</span> <span style=color:#f92672>]</span>,
            <span style=color:#e6db74>&#34;trustedIdentities&#34;</span>: <span style=color:#f92672>[</span>
                <span style=color:#e6db74>&#34;*&#34;</span>
            <span style=color:#f92672>]</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>]</span>
<span style=color:#f92672>}</span>
EOF
</code></pre></div><p>Verify that the image is signed, against the trust store.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>notation verify --plain-http $IMAGE
</code></pre></div><p>But now, let&rsquo;s get more detail and see what is a signature.</p><h2 id=inpspect-the-signature-artifacts>Inpspect the signature artifacts</h2><p>As of now of Notation v0.12 a signature is an ORAS <a href=https://github.com/oras-project/artifacts-spec>artifact-spec</a> compatible OCI image, on an OCI registry that references an OCI image.
As a digest makes unique an artifact (i.e. an image), the <code>subject</code> field of the signature image manifest references the signing content.</p><p>Let&rsquo;s check that on our local registry!</p><h3 id=inspect-with-oras-cli>Inspect with ORAS CLI</h3><p>First, install a ORAS CLI release with version &lt; 0.16.0.</p><blockquote><p>Later we&rsquo;ll see why not 0.16.</p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ oras discover $IMAGE -o json
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;referrers&#34;</span>: <span style=color:#f92672>[</span>
    <span style=color:#f92672>{</span>
      <span style=color:#e6db74>&#34;digest&#34;</span>: <span style=color:#e6db74>&#34;sha256:6131e049f4e045614d575ade11e9c9b44e6b7fb081fdd0b8a27f1726329eb5ab&#34;</span>,
      <span style=color:#e6db74>&#34;mediaType&#34;</span>: <span style=color:#e6db74>&#34;application/vnd.cncf.oras.artifact.manifest.v1+json&#34;</span>,
      <span style=color:#e6db74>&#34;artifactType&#34;</span>: <span style=color:#e6db74>&#34;application/vnd.cncf.notary.v2.signature&#34;</span>,
      <span style=color:#e6db74>&#34;size&#34;</span>: <span style=color:#ae81ff>512</span>
    <span style=color:#f92672>}</span>,
    <span style=color:#f92672>{</span>
      <span style=color:#e6db74>&#34;digest&#34;</span>: <span style=color:#e6db74>&#34;sha256:cdb664bc205fccbfc06cff7310ea42fe8cf483deb2c9e77a3c829c5d3ecde037&#34;</span>,
      <span style=color:#e6db74>&#34;mediaType&#34;</span>: <span style=color:#e6db74>&#34;application/vnd.cncf.oras.artifact.manifest.v1+json&#34;</span>,
      <span style=color:#e6db74>&#34;artifactType&#34;</span>: <span style=color:#e6db74>&#34;application/vnd.cncf.notary.v2.signature&#34;</span>,
      <span style=color:#e6db74>&#34;size&#34;</span>: <span style=color:#ae81ff>512</span>
    <span style=color:#f92672>}</span>
  <span style=color:#f92672>]</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>And you can see that the artifacts digests match the signatures pushed by Notation.</p><p>Now let&rsquo;s see how is composed a <code>application/vnd.cncf.notary.v2.signature</code> manifest, by picking the first signature:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ oras manifest fetch <span style=color:#e6db74>${</span>REPO<span style=color:#e6db74>}</span>@<span style=color:#66d9ef>$(</span>oras discover $IMAGE -o json | jq -r <span style=color:#e6db74>&#39;.referrers[0].digest&#39;</span><span style=color:#66d9ef>)</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  | jq
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;mediaType&#34;</span>: <span style=color:#e6db74>&#34;application/vnd.cncf.oras.artifact.manifest.v1+json&#34;</span>,
  <span style=color:#e6db74>&#34;artifactType&#34;</span>: <span style=color:#e6db74>&#34;application/vnd.cncf.notary.v2.signature&#34;</span>,
  <span style=color:#e6db74>&#34;blobs&#34;</span>: <span style=color:#f92672>[</span>
    <span style=color:#f92672>{</span>
      <span style=color:#e6db74>&#34;mediaType&#34;</span>: <span style=color:#e6db74>&#34;application/jose+json&#34;</span>,
      <span style=color:#e6db74>&#34;digest&#34;</span>: <span style=color:#e6db74>&#34;sha256:187e7739f84c8b7770dacfda80917ac1c671b92de192bdadf16c87ca0611d846&#34;</span>,
      <span style=color:#e6db74>&#34;size&#34;</span>: <span style=color:#ae81ff>2120</span>
    <span style=color:#f92672>}</span>
  <span style=color:#f92672>]</span>,
  <span style=color:#e6db74>&#34;subject&#34;</span>: <span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;mediaType&#34;</span>: <span style=color:#e6db74>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span>,
    <span style=color:#e6db74>&#34;digest&#34;</span>: <span style=color:#e6db74>&#34;sha256:79cf36c749e0e7445335567b97719bddaf57d0f465f9f36bcbe7ce0a25d02ec6&#34;</span>,
    <span style=color:#e6db74>&#34;size&#34;</span>: <span style=color:#ae81ff>942</span>
  <span style=color:#f92672>}</span>,
  <span style=color:#e6db74>&#34;annotations&#34;</span>: <span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;io.cncf.oras.artifact.created&#34;</span>: <span style=color:#e6db74>&#34;2022-11-14T18:38:51Z&#34;</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>As you can see the <code>subject</code> field references the Docker image <a href=https://docs.docker.com/registry/spec/manifest-v2-2/>manifest v2</a> of the signed image.</p><h2 id=show-me-the-code>Show me the code</h2><p>Now let&rsquo;s see what the <code>notation sign</code> command does.
<a href=https://github.com/notaryproject/notation/blob/v0.11.0-alpha.4/cmd/notation/sign.go#L83><code>runSign()</code></a> is the core part of the command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>runSign</span>(<span style=color:#a6e22e>command</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cobra</span>.<span style=color:#a6e22e>Command</span>, <span style=color:#a6e22e>cmdOpts</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>signOpts</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#75715e>// initialize
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>signer</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>GetSigner</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cmdOpts</span>.<span style=color:#a6e22e>SignerFlagOpts</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
	}

	<span style=color:#75715e>// core process
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>desc</span>, <span style=color:#a6e22e>opts</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>prepareSigningContent</span>(<span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#a6e22e>cmdOpts</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
	}
	<span style=color:#a6e22e>sig</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>signer</span>.<span style=color:#a6e22e>Sign</span>(<span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#a6e22e>desc</span>, <span style=color:#a6e22e>opts</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
	}

	<span style=color:#75715e>// write out
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>path</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmdOpts</span>.<span style=color:#a6e22e>output</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
		<span style=color:#a6e22e>path</span> = <span style=color:#a6e22e>dir</span>.<span style=color:#a6e22e>Path</span>.<span style=color:#a6e22e>CachedSignature</span>(<span style=color:#a6e22e>digest</span>.<span style=color:#a6e22e>Digest</span>(<span style=color:#a6e22e>desc</span>.<span style=color:#a6e22e>Digest</span>), <span style=color:#a6e22e>digest</span>.<span style=color:#a6e22e>FromBytes</span>(<span style=color:#a6e22e>sig</span>))
	}
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>osutil</span>.<span style=color:#a6e22e>WriteFile</span>(<span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>sig</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
	}

	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ref</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmdOpts</span>.<span style=color:#a6e22e>pushReference</span>; <span style=color:#a6e22e>cmdOpts</span>.<span style=color:#a6e22e>push</span> <span style=color:#f92672>&amp;&amp;</span> !(<span style=color:#a6e22e>cmdOpts</span>.<span style=color:#a6e22e>Local</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>ref</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>) {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ref</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
			<span style=color:#a6e22e>ref</span> = <span style=color:#a6e22e>cmdOpts</span>.<span style=color:#a6e22e>reference</span>
		}
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pushSignature</span>(<span style=color:#a6e22e>command</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cmdOpts</span>.<span style=color:#a6e22e>SecureFlagOpts</span>, <span style=color:#a6e22e>ref</span>, <span style=color:#a6e22e>sig</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;fail to push signature to %q: %v: %v&#34;</span>,
				<span style=color:#a6e22e>ref</span>,
				<span style=color:#a6e22e>desc</span>.<span style=color:#a6e22e>Digest</span>,
				<span style=color:#a6e22e>err</span>,
			)
		}
	}

	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>desc</span>.<span style=color:#a6e22e>Digest</span>)
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>First, a <code>signer</code> is fetched. A signer here is a component that signs an artifact and generate and signature.</p><p><a href=https://github.com/notaryproject/notation/blob/v0.11.0-alpha.4/cmd/notation/sign.go#L126><code>prepareSigningContent()</code></a> prepares the manifest <a href=https://github.com/opencontainers/image-spec/blob/main/descriptor.md#oci-content-descriptors>descriptor</a> to be signed:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>prepareSigningContent</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>signOpts</span>) (<span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>Descriptor</span>, <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>SignOptions</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>manifestDesc</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getManifestDescriptorFromContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>RemoteFlagOpts</span>, <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>reference</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>Descriptor</span>{}, <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>SignOptions</span>{}, <span style=color:#a6e22e>err</span>
	}
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>identity</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>originReference</span>; <span style=color:#a6e22e>identity</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
		<span style=color:#a6e22e>manifestDesc</span>.<span style=color:#a6e22e>Annotations</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
			<span style=color:#e6db74>&#34;identity&#34;</span>: <span style=color:#a6e22e>identity</span>,
		}
	}
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>tsa</span> <span style=color:#a6e22e>timestamp</span>.<span style=color:#a6e22e>Timestamper</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>endpoint</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>timestamp</span>; <span style=color:#a6e22e>endpoint</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tsa</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>timestamp</span>.<span style=color:#a6e22e>NewHTTPTimestamper</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>endpoint</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>Descriptor</span>{}, <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>SignOptions</span>{}, <span style=color:#a6e22e>err</span>
		}
	}
	<span style=color:#a6e22e>pluginConfig</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>ParseFlagPluginConfig</span>(<span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>pluginConfig</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>Descriptor</span>{}, <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>SignOptions</span>{}, <span style=color:#a6e22e>err</span>
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>manifestDesc</span>, <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>SignOptions</span>{
		<span style=color:#a6e22e>Expiry</span>:       <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>GetExpiry</span>(<span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>expiry</span>),
		<span style=color:#a6e22e>TSA</span>:          <span style=color:#a6e22e>tsa</span>,
		<span style=color:#a6e22e>PluginConfig</span>: <span style=color:#a6e22e>pluginConfig</span>,
	}, <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>the <code>signer</code> signs artifacts and generates signatures by delegating the <a href=https://github.com/notaryproject/notation-go/blob/v0.11.0-alpha.4/signature/plugin.go#L46>one or more operations</a> to the named plugin that will only generate a raw signature given a payload to sign.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Sign signs the artifact described by its descriptor and returns the marshalled envelope.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pluginSigner</span>) <span style=color:#a6e22e>Sign</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>desc</span> <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>Descriptor</span>, <span style=color:#a6e22e>opts</span> <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>SignOptions</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>metadata</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>getMetadata</span>(<span style=color:#a6e22e>ctx</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}
	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>SupportsContract</span>(<span style=color:#a6e22e>plugin</span>.<span style=color:#a6e22e>ContractVersion</span>) {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(
			<span style=color:#e6db74>&#34;contract version %q is not in the list of the plugin supported versions %v&#34;</span>,
			<span style=color:#a6e22e>plugin</span>.<span style=color:#a6e22e>ContractVersion</span>, <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>SupportedContractVersions</span>,
		)
	}
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>HasCapability</span>(<span style=color:#a6e22e>plugin</span>.<span style=color:#a6e22e>CapabilitySignatureGenerator</span>) {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>generateSignature</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>desc</span>, <span style=color:#a6e22e>opts</span>)
	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>HasCapability</span>(<span style=color:#a6e22e>plugin</span>.<span style=color:#a6e22e>CapabilityEnvelopeGenerator</span>) {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>generateSignatureEnvelope</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>desc</span>, <span style=color:#a6e22e>opts</span>)
	}
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;plugin does not have signing capabilities&#34;</span>)
}
</code></pre></div><p>Finally, Notation will package this signature into a signature envelope, and generate and pushes the signature manifest, through <a href=https://github.com/notaryproject/notation/blob/v0.11.0-alpha.4/cmd/notation/push.go#L90><code>pushSignature</code></a>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>pushSignature</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SecureFlagOpts</span>, <span style=color:#a6e22e>ref</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>sig</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>Descriptor</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#75715e>// initialize
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>sigRepo</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getSignatureRepository</span>(<span style=color:#a6e22e>opts</span>, <span style=color:#a6e22e>ref</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>Descriptor</span>{}, <span style=color:#a6e22e>err</span>
	}
	<span style=color:#a6e22e>manifestDesc</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getManifestDescriptorFromReference</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>opts</span>, <span style=color:#a6e22e>ref</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>Descriptor</span>{}, <span style=color:#a6e22e>err</span>
	}

	<span style=color:#75715e>// core process
</span><span style=color:#75715e></span>	<span style=color:#75715e>// pass in nonempty annotations if needed
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>sigMediaType</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>envelope</span>.<span style=color:#a6e22e>SpeculateSignatureEnvelopeFormat</span>(<span style=color:#a6e22e>sig</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>Descriptor</span>{}, <span style=color:#a6e22e>err</span>
	}
	<span style=color:#a6e22e>sigDesc</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sigRepo</span>.<span style=color:#a6e22e>PutSignatureManifest</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>sig</span>, <span style=color:#a6e22e>sigMediaType</span>, <span style=color:#a6e22e>manifestDesc</span>, make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>))
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>notation</span>.<span style=color:#a6e22e>Descriptor</span>{}, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;put signature manifest failure: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sigDesc</span>, <span style=color:#66d9ef>nil</span>
}
</code></pre></div><h3 id=signing-protocols-jose-and-cose>Signing protocols: JOSE and COSE</h3><p>As a detail, the <a href=https://github.com/notaryproject/notation/blob/v0.11.0-alpha.4/internal/cmd/signer.go#L58>supported signing protocols</a> are <a href=https://www.rfc-editor.org/rfc/rfc7515>JWS</a> and <a href=https://www.rfc-editor.org/rfc/rfc9052>COSE</a>.</p><p>The <a href=https://jose.readthedocs.io/en/latest/>JOSE</a> Working Group produced a set of documents (<a href=https://www.rfc-editor.org/rfc/rfc7515>RFC7515</a>, <a href=https://www.rfc-editor.org/rfc/rfc7516>RFC7516</a>, <a href=https://www.rfc-editor.org/rfc/rfc7517>RFC7517</a>, <a href=https://www.rfc-editor.org/rfc/rfc7518>RFC7518</a>) that specified how to process encryption, signatures, and Message Authentication Code (MAC) operations and how to encode keys using JSON (like for JWS).</p><p>JWS represents content secured with digital signatures or Message Authentication Codes (MACs) using JSON-based data structures.</p><p>COSE describes how to create and process signatures, message authentication codes, and encryption using CBOR for serialization.
<a href=https://www.rfc-editor.org/rfc/rfc7049>CBOR</a> is a data format that was designed specifically to be small in terms of both messages transported and implementation size and to have a schema-free decoder.</p><p>CBOR extended the data model of JavaScript Object Notation (JSON) by allowing for binary data directly without first converting it into a base64-encoded text string, among other changes.</p><p>COSE is not a direct copy of the JOSE specification. In the process of creating COSE, decisions that were made for JOSE were re-examined.</p><h2 id=whats-next>What&rsquo;s next</h2><p>It happened that ORAS worked to unify their artifact specification into a new OCI standard specification (Reference Types for image and distribution specs).</p><p>We&rsquo;re waiting to see a bump in the Notation Go library to <a href=https://github.com/notaryproject/notation-go/issues/136>support</a> the new Reference Type (and then Notation CLI) of the ORAS Go library (now release candidate <a href=https://github.com/oras-project/oras-go/tree/v2.0.0-rc.4>v2.0.0-rc.4</a>).</p><p>ORAS CLI <a href=https://github.com/oras-project/oras/releases/tag/v0.16.0>v0.16.0</a> already leverages OCI artifacts, and that&rsquo;s why in this demonstration we picked a previous version, as we demonstrate ORAS Artifact-based signatures.</p><p>See you soon with updates on OCI Artifact-based signatures!</p><hr><p>Sources:</p><ul><li><a href=https://oras.land/blog/oras-0.15-a-fully-functional-registry-client/#whats-next-for-oras>https://oras.land/blog/oras-0.15-a-fully-functional-registry-client/#whats-next-for-oras</a></li><li><a href=https://github.com/opencontainers/image-spec/pull/934>https://github.com/opencontainers/image-spec/pull/934</a></li><li><a href=https://github.com/opencontainers/distribution-spec/pull/335>https://github.com/opencontainers/distribution-spec/pull/335</a></li><li><a href=https://github.com/oras-project/oras-go/issues/271>https://github.com/oras-project/oras-go/issues/271</a></li><li><a href=https://github.com/notaryproject/notation-go/issues/136>https://github.com/notaryproject/notation-go/issues/136</a></li></ul></section><nav class=post-nav><a class=prev href=https://notes.maxgio.me/notes/networking/><span>←</span><span>Networking</span></a>
<a class=next href=https://notes.maxgio.me/notes/oci-signatures/><span>OCI signatures</span><span>→</span></a></nav></article></main><footer class=footer><p>&copy; 2022 <a href=https://notes.maxgio.me/>maxgio's notes</a></p><p>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>️</p><p><a href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>Paper 5.1</a></p></footer></body></html>