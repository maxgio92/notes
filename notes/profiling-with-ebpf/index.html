<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>CPU profiling with eBPF - maxgio's notes</title><meta name=description content="libbpf:
 Docs: https://www.kernel.org/doc/html/latest/bpf/libbpf/ Example: https://github.com/libbpf/libbpf-bootstrap/blob/master/examples/c/profile.bpf.c From BCC: https://nakryiko.com/posts/bcc-to-libbpf-howto-guide/  Examples from Linux sources:
 User space: https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/samples/bpf/trace_event_user.c Kernel space: https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/samples/bpf/trace_event_kern.c  Perf UAPI and eBPF user libraries:
 perf_event_attr struct: https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/include/uapi/linux/perf_event.h#L389 perf_event_open syscall: https://man7.org/linux/man-pages/man2/perf_event_open.2.html perf: https://perf.wiki.kernel.org/index.php/Main_Page How to attach per events with Cilium:  https://gist.github.com/florianl/5d9cc9dbb3822e03f6f65a073ffbedbb https://github.com/cilium/ebpf/discussions/800 https://github.com/cilium/ebpf/discussions/548    Blogs:
 https://www.brendangregg.com/blog/2016-10-21/linux-efficient-profiler.html https://blog.px.dev/cpu-profiling/ (a series) https://github.com/pixie-io/pixie-demos/blob/main/ebpf-profiler (with BCC) https://www.airplane.dev/blog/building-an-ebpf-based-profiler (with libbpf)  Other material:
 Perf ring buffer and lost events BPF ring buffer BPF_MAP_TYPE_STACK Brendan Gregg&rsquo;s stack trace hack [Official Linux Offwaketime:  bpf user   https://stackoverflow."><meta name=author content><link rel="preload stylesheet" as=style href=https://notes.maxgio.me/app.min.css><link rel="preload stylesheet" as=style href=https://notes.maxgio.me/an-old-hope.min.css><script defer src=https://notes.maxgio.me/highlight.min.js onload=hljs.initHighlightingOnLoad();></script><link rel=preload as=image href=https://notes.maxgio.me/theme.png><link rel=icon href=https://notes.maxgio.me/favicon.ico><link rel=apple-touch-icon href=https://notes.maxgio.me/apple-touch-icon.png><meta name=generator content="Hugo 0.79.1"><meta property="og:title" content="CPU profiling with eBPF"><meta property="og:description" content="libbpf:
 Docs: https://www.kernel.org/doc/html/latest/bpf/libbpf/ Example: https://github.com/libbpf/libbpf-bootstrap/blob/master/examples/c/profile.bpf.c From BCC: https://nakryiko.com/posts/bcc-to-libbpf-howto-guide/  Examples from Linux sources:
 User space: https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/samples/bpf/trace_event_user.c Kernel space: https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/samples/bpf/trace_event_kern.c  Perf UAPI and eBPF user libraries:
 perf_event_attr struct: https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/include/uapi/linux/perf_event.h#L389 perf_event_open syscall: https://man7.org/linux/man-pages/man2/perf_event_open.2.html perf: https://perf.wiki.kernel.org/index.php/Main_Page How to attach per events with Cilium:  https://gist.github.com/florianl/5d9cc9dbb3822e03f6f65a073ffbedbb https://github.com/cilium/ebpf/discussions/800 https://github.com/cilium/ebpf/discussions/548    Blogs:
 https://www.brendangregg.com/blog/2016-10-21/linux-efficient-profiler.html https://blog.px.dev/cpu-profiling/ (a series) https://github.com/pixie-io/pixie-demos/blob/main/ebpf-profiler (with BCC) https://www.airplane.dev/blog/building-an-ebpf-based-profiler (with libbpf)  Other material:
 Perf ring buffer and lost events BPF ring buffer BPF_MAP_TYPE_STACK Brendan Gregg&rsquo;s stack trace hack [Official Linux Offwaketime:  bpf user   https://stackoverflow."><meta property="og:type" content="article"><meta property="og:url" content="https://notes.maxgio.me/notes/profiling-with-ebpf/"><meta itemprop=name content="CPU profiling with eBPF"><meta itemprop=description content="libbpf:
 Docs: https://www.kernel.org/doc/html/latest/bpf/libbpf/ Example: https://github.com/libbpf/libbpf-bootstrap/blob/master/examples/c/profile.bpf.c From BCC: https://nakryiko.com/posts/bcc-to-libbpf-howto-guide/  Examples from Linux sources:
 User space: https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/samples/bpf/trace_event_user.c Kernel space: https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/samples/bpf/trace_event_kern.c  Perf UAPI and eBPF user libraries:
 perf_event_attr struct: https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/include/uapi/linux/perf_event.h#L389 perf_event_open syscall: https://man7.org/linux/man-pages/man2/perf_event_open.2.html perf: https://perf.wiki.kernel.org/index.php/Main_Page How to attach per events with Cilium:  https://gist.github.com/florianl/5d9cc9dbb3822e03f6f65a073ffbedbb https://github.com/cilium/ebpf/discussions/800 https://github.com/cilium/ebpf/discussions/548    Blogs:
 https://www.brendangregg.com/blog/2016-10-21/linux-efficient-profiler.html https://blog.px.dev/cpu-profiling/ (a series) https://github.com/pixie-io/pixie-demos/blob/main/ebpf-profiler (with BCC) https://www.airplane.dev/blog/building-an-ebpf-based-profiler (with libbpf)  Other material:
 Perf ring buffer and lost events BPF ring buffer BPF_MAP_TYPE_STACK Brendan Gregg&rsquo;s stack trace hack [Official Linux Offwaketime:  bpf user   https://stackoverflow."><meta itemprop=wordCount content="105"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="CPU profiling with eBPF"><meta name=twitter:description content="libbpf:
 Docs: https://www.kernel.org/doc/html/latest/bpf/libbpf/ Example: https://github.com/libbpf/libbpf-bootstrap/blob/master/examples/c/profile.bpf.c From BCC: https://nakryiko.com/posts/bcc-to-libbpf-howto-guide/  Examples from Linux sources:
 User space: https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/samples/bpf/trace_event_user.c Kernel space: https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/samples/bpf/trace_event_kern.c  Perf UAPI and eBPF user libraries:
 perf_event_attr struct: https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/include/uapi/linux/perf_event.h#L389 perf_event_open syscall: https://man7.org/linux/man-pages/man2/perf_event_open.2.html perf: https://perf.wiki.kernel.org/index.php/Main_Page How to attach per events with Cilium:  https://gist.github.com/florianl/5d9cc9dbb3822e03f6f65a073ffbedbb https://github.com/cilium/ebpf/discussions/800 https://github.com/cilium/ebpf/discussions/548    Blogs:
 https://www.brendangregg.com/blog/2016-10-21/linux-efficient-profiler.html https://blog.px.dev/cpu-profiling/ (a series) https://github.com/pixie-io/pixie-demos/blob/main/ebpf-profiler (with BCC) https://www.airplane.dev/blog/building-an-ebpf-based-profiler (with libbpf)  Other material:
 Perf ring buffer and lost events BPF ring buffer BPF_MAP_TYPE_STACK Brendan Gregg&rsquo;s stack trace hack [Official Linux Offwaketime:  bpf user   https://stackoverflow."></head><body class=not-ready data-menu=false><header class=header><p class=logo><a class=site-name href=https://notes.maxgio.me/>maxgio's notes</a><a class=btn-dark></a></p><script>let bodyClx=document.body.classList;let btnDark=document.querySelector('.btn-dark');let sysDark=window.matchMedia('(prefers-color-scheme: dark)');let darkVal=localStorage.getItem('dark');let setDark=(isDark)=>{bodyClx[isDark?'add':'remove']('dark');localStorage.setItem('dark',isDark?'yes':'no');};setDark(darkVal?darkVal==='yes':sysDark.matches);requestAnimationFrame(()=>bodyClx.remove('not-ready'));btnDark.addEventListener('click',()=>setDark(!bodyClx.contains('dark')));sysDark.addEventListener('change',(event)=>setDark(event.matches));</script></header><main class=main><article class=post-single><header class=post-title><p></p><h1>CPU profiling with eBPF</h1></header><section class=post-content><p>libbpf:</p><ul><li>Docs: <a href=https://www.kernel.org/doc/html/latest/bpf/libbpf/>https://www.kernel.org/doc/html/latest/bpf/libbpf/</a></li><li>Example: <a href=https://github.com/libbpf/libbpf-bootstrap/blob/master/examples/c/profile.bpf.c>https://github.com/libbpf/libbpf-bootstrap/blob/master/examples/c/profile.bpf.c</a></li><li>From BCC: <a href=https://nakryiko.com/posts/bcc-to-libbpf-howto-guide/>https://nakryiko.com/posts/bcc-to-libbpf-howto-guide/</a></li></ul><p>Examples from Linux sources:</p><ul><li>User space: <a href=https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/samples/bpf/trace_event_user.c>https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/samples/bpf/trace_event_user.c</a></li><li>Kernel space: <a href=https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/samples/bpf/trace_event_kern.c>https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/samples/bpf/trace_event_kern.c</a></li></ul><p>Perf UAPI and eBPF user libraries:</p><ul><li><code>perf_event_attr</code> struct: <a href=https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/include/uapi/linux/perf_event.h#L389>https://github.com/torvalds/linux/blob/b0546776ad3f332e215cebc0b063ba4351971cca/include/uapi/linux/perf_event.h#L389</a></li><li><code>perf_event_open</code> syscall: <a href=https://man7.org/linux/man-pages/man2/perf_event_open.2.html>https://man7.org/linux/man-pages/man2/perf_event_open.2.html</a></li><li>perf: <a href=https://perf.wiki.kernel.org/index.php/Main_Page>https://perf.wiki.kernel.org/index.php/Main_Page</a></li><li>How to attach per events with Cilium:<ul><li><a href=https://gist.github.com/florianl/5d9cc9dbb3822e03f6f65a073ffbedbb>https://gist.github.com/florianl/5d9cc9dbb3822e03f6f65a073ffbedbb</a></li><li><a href=https://github.com/cilium/ebpf/discussions/800>https://github.com/cilium/ebpf/discussions/800</a></li><li><a href=https://github.com/cilium/ebpf/discussions/548>https://github.com/cilium/ebpf/discussions/548</a></li></ul></li></ul><p>Blogs:</p><ul><li><a href=https://www.brendangregg.com/blog/2016-10-21/linux-efficient-profiler.html>https://www.brendangregg.com/blog/2016-10-21/linux-efficient-profiler.html</a></li><li><a href=https://blog.px.dev/cpu-profiling/>https://blog.px.dev/cpu-profiling/</a> (a series)</li><li><a href=https://github.com/pixie-io/pixie-demos/blob/main/ebpf-profiler>https://github.com/pixie-io/pixie-demos/blob/main/ebpf-profiler</a> (with BCC)</li><li><a href=https://www.airplane.dev/blog/building-an-ebpf-based-profiler>https://www.airplane.dev/blog/building-an-ebpf-based-profiler</a> (with libbpf)</li></ul><p>Other material:</p><ul><li><a href=http://blog.itaysk.com/2020/04/20/ebpf-lost-events>Perf ring buffer and lost events</a></li><li><a href=https://www.kernel.org/doc/html/latest/bpf/ringbuf.html>BPF ring buffer</a></li><li><a href=https://www.kernel.org/doc/html/latest/bpf/map_queue_stack.html><code>BPF_MAP_TYPE_STACK</code></a></li><li><a href=https://www.brendangregg.com/blog/2016-01-18/ebpf-stack-trace-hack.html>Brendan Gregg&rsquo;s stack trace hack</a></li><li>[Official Linux Offwaketime:<ul><li><a href=https://elixir.bootlin.com/linux/latest/source/samples/bpf/offwaketime.bpf.c>bpf</a></li><li><a href=https://elixir.bootlin.com/linux/latest/source/samples/bpf/offwaketime_user.c>user</a></li></ul></li><li><a href=https://stackoverflow.com/questions/23618743/implementing-an-interrupt-driven-sampling-profiler>https://stackoverflow.com/questions/23618743/implementing-an-interrupt-driven-sampling-profiler</a></li></ul><p>Stack walking:</p><ul><li><a href=./X86-stack-walking.pdf>x86 assembly</a></li><li><a href=https://c9x.me/x86/html/file_module_x86_id_154.html>https://c9x.me/x86/html/file_module_x86_id_154.html</a></li><li><a href=https://www.polarsignals.com/blog/posts/2022/11/29/dwarf-based-stack-walking-using-ebpf>https://www.polarsignals.com/blog/posts/2022/11/29/dwarf-based-stack-walking-using-ebpf</a></li><li><a href=https://github.com/DataDog/go-profiler-notes/blob/main/stack-traces.md>DataDog&rsquo;s Stack traces in Go</a></li><li><a href=https://stackoverflow.com/questions/57268045/how-to-read-stack-trace-kernelside-in-ebpf>https://stackoverflow.com/questions/57268045/how-to-read-stack-trace-kernelside-in-ebpf</a></li><li>NEW: <a href=https://www.brendangregg.com/blog/2024-03-17/the-return-of-the-frame-pointers.html>https://www.brendangregg.com/blog/2024-03-17/the-return-of-the-frame-pointers.html</a></li></ul><p>Symbolization:</p><ul><li><a href=https://jvns.ca/blog/2018/01/09/resolving-symbol-addresses/>https://jvns.ca/blog/2018/01/09/resolving-symbol-addresses/</a></li><li><a href=https://www.polarsignals.com/blog/posts/2022/01/13/fantastic-symbols-and-where-to-find-them>https://www.polarsignals.com/blog/posts/2022/01/13/fantastic-symbols-and-where-to-find-them</a></li><li><a href=https://mpatrol.sourceforge.net/doc/Call-stacks-and-symbol-tables.html>https://mpatrol.sourceforge.net/doc/Call-stacks-and-symbol-tables.html</a></li></ul><p>Beyond frame pointers:</p><ul><li>ORC: <a href=https://lwn.net/Articles/728339/>https://lwn.net/Articles/728339/</a></li><li>LBR: <a href=https://lwn.net/Articles/680985/>https://lwn.net/Articles/680985/</a></li></ul><p>Extra:</p><ul><li>Off-CPU profiling: <a href=https://www.brendangregg.com/FlameGraphs/offcpuflamegraphs.html>https://www.brendangregg.com/FlameGraphs/offcpuflamegraphs.html</a></li></ul></section><nav class=post-nav><a class=prev href=https://notes.maxgio.me/notes/cosign/><span>←</span><span>Cosign and keyless signing</span></a>
<a class=next href=https://notes.maxgio.me/notes/csi-fsgroup/><span>CSI and fsGroup</span><span>→</span></a></nav></article></main><footer class=footer><p>&copy; 2024 <a href=https://notes.maxgio.me/>maxgio's notes</a></p><p>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>️</p><p><a href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>Paper 5.1</a></p></footer></body></html>