<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Kind with Podman rootless mode on WSL2 - maxgio's notes</title><meta name=description content="sudo apt update Install podman
sudo apt install -y podman Configure podman /etc/containers/containers.conf
log_driver = &#34;k8s-file&#34; events_logger = &#34;file&#34; cgroup_manager = &#34;cgroupfs&#34; Install kind
Disable cgroupv1 for the WSL instance (or globally at \Users${USER}.wslconfig) , for all cgroup controllers - ref: https://devpress.csdn.net/postgresql/630fab296a097251580cf46e.html
cat <<EOF >/etc/wsl.conf [wsl2] kernelCommandLine = cgroup_no_v1=all EOF From Windows host, restart WSL
wsl --shutdown Move the cgroupv2 mount to classic /sys/fs/cgroup, for podman/docker clients
cat <<EOF >>/etc/fstab cgroup2 /sys/fs/cgroup cgroup2 rw,nosuid,nodev,noexec,relatime,nsdelegate 0 0 EOF mount -a Install missing CNI plugins v1."><meta name=author content><link rel="preload stylesheet" as=style href=https://notes.maxgio.me/app.min.css><link rel="preload stylesheet" as=style href=https://notes.maxgio.me/an-old-hope.min.css><script defer src=https://notes.maxgio.me/highlight.min.js onload=hljs.initHighlightingOnLoad();></script><link rel=preload as=image href=https://notes.maxgio.me/theme.png><link rel=icon href=https://notes.maxgio.me/favicon.ico><link rel=apple-touch-icon href=https://notes.maxgio.me/apple-touch-icon.png><meta name=generator content="Hugo 0.79.1"><meta property="og:title" content="Kind with Podman rootless mode on WSL2"><meta property="og:description" content="sudo apt update Install podman
sudo apt install -y podman Configure podman /etc/containers/containers.conf
log_driver = &#34;k8s-file&#34; events_logger = &#34;file&#34; cgroup_manager = &#34;cgroupfs&#34; Install kind
Disable cgroupv1 for the WSL instance (or globally at \Users${USER}.wslconfig) , for all cgroup controllers - ref: https://devpress.csdn.net/postgresql/630fab296a097251580cf46e.html
cat <<EOF >/etc/wsl.conf [wsl2] kernelCommandLine = cgroup_no_v1=all EOF From Windows host, restart WSL
wsl --shutdown Move the cgroupv2 mount to classic /sys/fs/cgroup, for podman/docker clients
cat <<EOF >>/etc/fstab cgroup2 /sys/fs/cgroup cgroup2 rw,nosuid,nodev,noexec,relatime,nsdelegate 0 0 EOF mount -a Install missing CNI plugins v1."><meta property="og:type" content="article"><meta property="og:url" content="https://notes.maxgio.me/notes/kind-podman-rootless-wsl2/"><meta itemprop=name content="Kind with Podman rootless mode on WSL2"><meta itemprop=description content="sudo apt update Install podman
sudo apt install -y podman Configure podman /etc/containers/containers.conf
log_driver = &#34;k8s-file&#34; events_logger = &#34;file&#34; cgroup_manager = &#34;cgroupfs&#34; Install kind
Disable cgroupv1 for the WSL instance (or globally at \Users${USER}.wslconfig) , for all cgroup controllers - ref: https://devpress.csdn.net/postgresql/630fab296a097251580cf46e.html
cat <<EOF >/etc/wsl.conf [wsl2] kernelCommandLine = cgroup_no_v1=all EOF From Windows host, restart WSL
wsl --shutdown Move the cgroupv2 mount to classic /sys/fs/cgroup, for podman/docker clients
cat <<EOF >>/etc/fstab cgroup2 /sys/fs/cgroup cgroup2 rw,nosuid,nodev,noexec,relatime,nsdelegate 0 0 EOF mount -a Install missing CNI plugins v1."><meta itemprop=wordCount content="162"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Kind with Podman rootless mode on WSL2"><meta name=twitter:description content="sudo apt update Install podman
sudo apt install -y podman Configure podman /etc/containers/containers.conf
log_driver = &#34;k8s-file&#34; events_logger = &#34;file&#34; cgroup_manager = &#34;cgroupfs&#34; Install kind
Disable cgroupv1 for the WSL instance (or globally at \Users${USER}.wslconfig) , for all cgroup controllers - ref: https://devpress.csdn.net/postgresql/630fab296a097251580cf46e.html
cat <<EOF >/etc/wsl.conf [wsl2] kernelCommandLine = cgroup_no_v1=all EOF From Windows host, restart WSL
wsl --shutdown Move the cgroupv2 mount to classic /sys/fs/cgroup, for podman/docker clients
cat <<EOF >>/etc/fstab cgroup2 /sys/fs/cgroup cgroup2 rw,nosuid,nodev,noexec,relatime,nsdelegate 0 0 EOF mount -a Install missing CNI plugins v1."></head><body class=not-ready data-menu=false><header class=header><p class=logo><a class=site-name href=https://notes.maxgio.me/>maxgio's notes</a><a class=btn-dark></a></p><script>let bodyClx=document.body.classList;let btnDark=document.querySelector('.btn-dark');let sysDark=window.matchMedia('(prefers-color-scheme: dark)');let darkVal=localStorage.getItem('dark');let setDark=(isDark)=>{bodyClx[isDark?'add':'remove']('dark');localStorage.setItem('dark',isDark?'yes':'no');};setDark(darkVal?darkVal==='yes':sysDark.matches);requestAnimationFrame(()=>bodyClx.remove('not-ready'));btnDark.addEventListener('click',()=>setDark(!bodyClx.contains('dark')));sysDark.addEventListener('change',(event)=>setDark(event.matches));</script></header><main class=main><article class=post-single><header class=post-title><p></p><h1>Kind with Podman rootless mode on WSL2</h1></header><section class=post-content><p>sudo apt update
Install podman</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo apt install -y podman
</code></pre></div><p>Configure podman /etc/containers/containers.conf</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>log_driver <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;k8s-file&#34;</span>
events_logger <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;file&#34;</span>
cgroup_manager <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cgroupfs&#34;</span>
</code></pre></div><p>Install kind</p><p>Disable cgroupv1 for the WSL instance (or globally at \Users${USER}.wslconfig) , for all cgroup controllers - ref: <a href=https://devpress.csdn.net/postgresql/630fab296a097251580cf46e.html>https://devpress.csdn.net/postgresql/630fab296a097251580cf46e.html</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cat <span style=color:#e6db74>&lt;&lt;EOF &gt;/etc/wsl.conf
</span><span style=color:#e6db74>[wsl2]
</span><span style=color:#e6db74>kernelCommandLine = cgroup_no_v1=all
</span><span style=color:#e6db74>EOF</span>
</code></pre></div><p>From Windows host, restart WSL</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>wsl --shutdown
</code></pre></div><p>Move the cgroupv2 mount to classic /sys/fs/cgroup, for podman/docker clients</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cat <span style=color:#e6db74>&lt;&lt;EOF &gt;&gt;/etc/fstab
</span><span style=color:#e6db74>cgroup2 /sys/fs/cgroup cgroup2 rw,nosuid,nodev,noexec,relatime,nsdelegate 0 0
</span><span style=color:#e6db74>EOF</span>
mount -a
</code></pre></div><p>Install missing CNI plugins v1.1.1 - ref: <a href=https://bugs.launchpad.net/ubuntu/+source/libpod/+bug/2024394>https://bugs.launchpad.net/ubuntu/+source/libpod/+bug/2024394</a></p><pre><code>curl -SLO http://archive.ubuntu.com/ubuntu/pool/universe/g/golang-github-containernetworking-plugins/containernetworking-plugins_1.1.1+ds1-3_amd64.deb
sudo dpkg -i containernetworking-plugins_1.1.1+ds1-3_amd64.deb
</code></pre><p>Upgrade crun >= 1.9.0 - ref: <a href=https://noobient.com/2023/11/15/fixing-ubuntu-containers-failing-to-start-with-systemd/>https://noobient.com/2023/11/15/fixing-ubuntu-containers-failing-to-start-with-systemd/</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>mkdir -p ~/.local/bin
curl -sL <span style=color:#e6db74>&#34;https://github.com/containers/crun/releases/download/</span><span style=color:#e6db74>${</span>CRUN_VER<span style=color:#e6db74>}</span><span style=color:#e6db74>/crun-</span><span style=color:#e6db74>${</span>CRUN_VER<span style=color:#e6db74>}</span><span style=color:#e6db74>-linux-amd64&#34;</span> -o <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>HOME<span style=color:#e6db74>}</span><span style=color:#e6db74>/.local/bin/crun&#34;</span>
chmod +x ~/.local/bin/crun
mkdir -p ~/.config/containers<span style=color:#e6db74>&#34;
</span><span style=color:#e6db74>cat &lt;&lt; EOF &gt; ~/.config/containers/containers.conf
</span><span style=color:#e6db74>[engine.runtimes]
</span><span style=color:#e6db74>crun = [
</span><span style=color:#e6db74>  &#34;</span><span style=color:#e6db74>${</span>HOME<span style=color:#e6db74>}</span>/.local/bin/crun<span style=color:#e6db74>&#34;,
</span><span style=color:#e6db74>  &#34;</span>/usr/bin/crun<span style=color:#e6db74>&#34;
</span><span style=color:#e6db74>]
</span><span style=color:#e6db74>EOF
</span><span style=color:#e6db74>podman info | grep -i crun
</span></code></pre></div><p>Configure systemd resource delegation - ref: <a href=https://unix.stackexchange.com/questions/624428/cgroups-v2-cgroup-controllers-not-delegated-to-non-privileged-users-on-centos-s/625079#625079>https://unix.stackexchange.com/questions/624428/cgroups-v2-cgroup-controllers-not-delegated-to-non-privileged-users-on-centos-s/625079#625079</a></p><p>/etc/systemd/system/user-0.slice:</p><pre><code>[Unit]
Before=systemd-logind.service
[Slice]
Slice=user.slice
[Install]
WantedBy=multi-user.target
</code></pre><p>/etc/systemd/system/user@.service.d/delegate.conf:</p><pre><code>[Service]
Delegate=cpu cpuset io memory pids
</code></pre><p>/etc/systemd/system/user-.slice.d/override.conf:</p><pre><code>[Slice]
Slice=user.slice

CPUAccounting=yes
MemoryAccounting=yes
IOAccounting=yes
TasksAccounting=yes
</code></pre></section><nav class=post-nav><a class=prev href=https://notes.maxgio.me/notes/2022-07-06-21-01-48/><span>←</span><span>K8s links</span></a>
<a class=next href=https://notes.maxgio.me/notes/kubectl-resources/><span>Kubectl resources</span><span>→</span></a></nav></article></main><footer class=footer><p>&copy; 2024 <a href=https://notes.maxgio.me/>maxgio's notes</a></p><p>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>️</p><p><a href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>Paper 5.1</a></p></footer></body></html>